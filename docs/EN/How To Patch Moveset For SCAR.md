# How To Patch Moveset for SCAR
This tutorial would instruct you on how to patch your moveset to supporting the customize AI attack combos feature of SCAR.   
The tutorial would be separated into two stages：  
* **Attack Ready Stage** 
* **Attack Combos Stage**
   
<br/> 

## Attack Ready Stage
---  

In order to add SCAR AI data- <u>*SCAR Action Data*</u> (refer as "ActionData") for the first attack action of your moveset, You have to patch the <u>*Behavior*</u> first: creating a <u>*DummyAnimation*</u>  under the behavior‘s <u>*AttackReadyStateMachine*</u>, then using this DummyAnimation as the container to store the ActionData of the first attack animations (In ADXP, that would be "MCO_attack1.hkx" & "MCO_powerattack1.hkx"), with it SCAR could retrieves the data on SKSE plugin end.
<br/>  
Luckily, For the attack behavior of <u>*Character*</u>, SCAR already created a DummyAnimation named "SCAR_1hmReadyDummy.hkx", so you don't need to patch behavior for character yourself. (Stil have to If for creature)   

The remaining things you need to do is annoate the ActionData of your first attack inside the "SCAR_1hmReadyDummy.hkx", then include this animation file into your moveset.  
<br/> 
Here is a code example of annotations that containing an ActionData:
```
1.000000 SCAR_ActionData{"IdleAnimation":"ADXP_NPCPowerAttack", "MinDistance":0, "MaxDistance":139, "StartAngle":-60, "EndAngle":60, "Chance":30, "Type":"RPA"}
```
The content of the annotations could divided into three segments, as the picture below illustrate：  

![1](../images/SCAR%20Action%20Data.jpg) 
*  `weight`: The float number `1.000000` in the leftmost originally represents the *local time* of the annotations, SCAR using it as the *weight* of the ActionData here.  
When there are multiple line of ActionData annotations inside an animation file, weight would be used to decide the proirty of the ActionData, SCAR will check the anooations one by one following the descending order of the weight, that mean the ActionData with higher weight would be checking first, and the first ActionData that meet all the conditions would be perform, while the rest would be igronaed.

* `prefix text`: The "SCAR_ActionData" text segment is nothing but a prefix identifier text. It does not contains any valid data, SCAR only use it to find out the one with SCAR Action Data from the many annotations.
   
* `json data`:  The last segment that enclosed in two curly braces is a standard [json format string](https://www.w3schools.com/js/js_json_syntax.asp), stored the actual data of an SCAR Action Data:

    * `IdleAnimation` : The EditorID of the [Idle Animation](https://www.creationkit.com/index.php?title=Idle_Animations) that would be performed by the ActionData when all the conditions are meeting.  
    Idle Animation is defined by the esp plugin, *ADXP-Beta-1.4* and above version already contains two valid idle animation: "ADXP_NPCPowerAttack" and "ADXP_NPCNormalAttack" in it mco.esp, which could be used to perform powerAttack and normalAttack separately.  
    The conditions items of the idle animation would also be take into consideration when doing conditions checking.  

    *  `MaxDistance`: The maximum distance range for the ActionData to excute, only when the distance between the moveset owner to the target less than this value, the ActionData could be excuted. The value of the distance must be greater than zero.  
    Be caution that the you don't need to consider the weapon reach when filling the Max Distance value there, the weapon reach would be computed dynamically on SKSE plugin end.
   
    *  `MinDistance`: The minmum distance range for the ActionData to excute, only when the distance between the moveset owner to the target greater than this value, the ActionData could be excuted. The value of the distance must be greater than zero.  
    MinDistance could be used to disable the performing of long distance attack when the distance to the target is close.
    
    *  `StartAngle` & `EndAngle` : These two variable are using together to generate a yaw angle range， only when the heading angle between the moveset owner to the target within this yaw angle range, the ActionData could be executed.  
    The valid value of the angle is from -180.0 to 180.0, yaw angle range is generated by drawing an arc in a clockwise direction that start at StartAngle and end at EndAngle. You can check [SampleImage1](https://raw.githubusercontent.com/max-su-2019/SCAR/main/docs/images/Scar%20Angle%20Range%2001.JPG) and [Sampleimage2](https://raw.githubusercontent.com/max-su-2019/SCAR/main/docs/images/Scar%20Angle%20Range%2002.JPG) for reference.

    * `Chance`: Then random chance to excute this ActionData, the valid value is 0 to 100. 
* 
    *  `Type`: The type of the action that executed by the ActionData, action type would affect the attack data and weapon reach, here are all the valid types supported by SCAR:  
    *RA - RightAttack*  
    *RPA - RightPowerAttack*  
    *LA - LeftAttack*  
    *LPA - LeftPowerAttack*  
    *DA - DualAttack*  
    *DPA - DualPowerAttack*   
    *BA - BashAttack*  
    *BPA - BashPowerAttack*  
    *IDLE - Regular Idle*   
<br/> 

Let's take the battleaxe moveset(DAR Folder 20006) of SCAR's default moveset package for example, to explain how SCAR doing it compute through the annotations.  
The SCAR related annotations inside its `SCAR_1hmReadyDummy.hkx` are as following： 
```
1.000000 SCAR_ActionData{"IdleAnimation":"ADXP_NPCPowerAttack", "MinDistance":120, "MaxDistance":247, "StartAngle":-45, "EndAngle":45, "Chance":30, "Type":"RPA"}
0.500000 SCAR_ActionData{"IdleAnimation":"ADXP_NPCNormalAttack", "MinDistance":0, "MaxDistance":48, "StartAngle":-60, "EndAngle":60, "Chance":100, "Type":"RA"}
```
The codes above contains two ActionData annotations, SCAR will check the annotation one by one by the descending order of the weight, Due to the fisrt line of annotation has weight 1.000000, while the second line has weight 0.500000, SCAR will firstly check the conditions of the first line:
* When the distance to the combat target within the range of 120 to (247 + weapon reach), as well as the heading angle to the combat target within -45 to 45 degree, then the moveset owner would has 30% of chance to perform the "ADXP_NPCPowerAttack" Idle animation that defined in the "mco.esp", the attack action type would be *right power attack*. While under ADXP framework, that mean the moveset owner would play "mco_powerattack1.hkx" next.  

If the first ActionData above doesn't meet all the conditions, then SCAR will check for the second one in lower weight:
* When the distance to the combat target within the range of 0 to (48 + weapon reach), as well as the heading angle to the combat target within -60 to 60 degree, then the moveset owner would has 100% of chance to perform the "ADXP_NPCNormalAttack" Idle animation that defined in the "mco.esp", the attack action type would be *right attack*. While under ADXP framework, that mean the moveset owner would play "mco_attack1.hkx" next. 

---    
<br/> <br/> 

## 攻击连招阶段
---  
要为攻击连招阶段添加SCAR支持，首先需要你在攻击动画所属的 **行为图(Behavior Graph)** 中添加一个名为 `SCAR_ComboStart` 的 **动作事件(animation event)** ，用来作为执行下一个连招攻击的AI判定窗口。  
幸运的是，SCAR和ADXP V1.4的行为补丁中已经添加了此动作事件，你无需自己修改行为或制作行为补丁(如果是生物moveset则需要)。  

下一步需要找到moveset里所有会继续衔接连招到下一个攻击的攻击动画文件，并为其添加表示可衔接到的下一个连招攻击动作的 ActionData 注解，方式和 `SCAR_1hmReadyDummy.hkx` 中的相同。比如，若你的`mco_attack1.hkx`动画分别可衔接到`mco_attack2`或`mco_powerattack2`，则需加入后两个动画对应的ActionData注解到  `mco_attack1.hkx` 文件中。  

除此之外，还需额外在你认为可开始执行衔接到下一个攻击动作的窗口时间里，加上 `SCAR_ComboStart` 这个动作事件。 对于ADXP而言，`SCAR_ComboStart` 的时间应位于 MCO_WinOpen 和 MCO_WinClose 之间、 或位于 MCO_PowerWinOpen 和 MCO_PowerWinClose 之间。  

以下是ADXP V1.4默认双手斧动作（既SCAR默认动作包20006）Moveset中的 `mco_attack1.hkx` 动画内的SCAR相关注解:  
```
1.550000 SCAR_ComboStart
1.000000 SCAR_ActionData{"IdleAnimation":"ADXP_NPCPowerAttack", "MinDistance":0, "MaxDistance":29, "StartAngle":-60, "EndAngle":60, "Chance":30, "Type":"RPA"}
0.500000 SCAR_ActionData{"IdleAnimation":"ADXP_NPCNormalAttack", "MinDistance":0, "MaxDistance":193, "StartAngle":-60, "EndAngle":60, "Chance":100, "Type":"RA"}
```
上述注解表示：当  `mco_attack1.hkx` 动画执行到1.550000秒时，会对注解中的两条 ActionData 进行判定和执行，若符合相应条件则会衔接到 `mco_attack2` 或 `mco_powerattack2` 中。  
<br/> 
### 额外可选操作：  
你可以在`SCAR_ComboStart`事件注解中通过后缀的方式设置下一个连招攻击触发的总几率，若不设置则默认为100%触发。代码实例：
```
1.550000 SCAR_ComboStart.60
```
表示有60%几率会继续执行下一个连招，40%几率停止攻击不再继续连招。

---

